(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{357:function(t,a,s){t.exports=s.p+"assets/img/pinned_memory.577c8cbe.jpg"},367:function(t,a,s){"use strict";s.r(a);var n=s(42),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"dataloader-中-pin-memory-的作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dataloader-中-pin-memory-的作用"}},[t._v("#")]),t._v(" DataLoader 中 pin_memory 的作用")]),t._v(" "),n("p",[t._v("難度：易")]),t._v(" "),n("p"),n("div",{staticClass:"table-of-contents"},[n("ul",[n("li",[n("a",{attrs:{href:"#什麼時候該使用"}},[t._v("什麼時候該使用")])]),n("li",[n("a",{attrs:{href:"#什麼時候沒有用"}},[t._v("什麼時候沒有用")])]),n("li",[n("a",{attrs:{href:"#原理"}},[t._v("原理")])]),n("li",[n("a",{attrs:{href:"#如何在-dataloader-中使用"}},[t._v("如何在 DataLoader 中使用")])]),n("li",[n("a",{attrs:{href:"#參考資料"}},[t._v("參考資料")])])])]),n("p"),t._v(" "),n("h2",{attrs:{id:"什麼時候該使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什麼時候該使用"}},[t._v("#")]),t._v(" 什麼時候該使用")]),t._v(" "),n("p",[t._v("在 "),n("code",[t._v("Dataset")]),t._v(" 中讀取資料到 CPU (RAM) 上，然後在訓練階段將資料轉移到 GPU 上。")]),t._v(" "),n("h2",{attrs:{id:"什麼時候沒有用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什麼時候沒有用"}},[t._v("#")]),t._v(" 什麼時候沒有用")]),t._v(" "),n("p",[t._v("在 "),n("code",[t._v("Dataset")]),t._v(" 中已經讀取資料到 GPU (vRAM) 上，然後在訓練階段不會將資料轉移到 GPU 上。重點是資料轉移的過程，沒有資料轉移就不會有額外消耗。")]),t._v(" "),n("h2",{attrs:{id:"原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[t._v("#")]),t._v(" 原理")]),t._v(" "),n("p",[t._v("Pinned 的意思是 page-locked（鎖定分頁的）。在 CPU 中，記憶體預設都是 pageable（可分頁的記憶體）。但是在可分頁記憶體中的資料無法直接傳入 GPU 的記憶體中，傳入前必須先進行鎖定。在 "),n("a",{attrs:{href:"https://developer.nvidia.com/blog/how-optimize-data-transfers-cuda-cc/",target:"_blank",rel:"noopener noreferrer"}},[t._v("NVIDIA blog"),n("OutboundLink")],1),t._v(" 中這麼說：")]),t._v(" "),n("blockquote",[n("p",[t._v("Host (CPU) data allocations are pageable by default. The GPU cannot access data directly from pageable host memory, so when a data transfer from pageable host memory to device memory is invoked, the CUDA driver must first allocate a temporary page-locked, or “pinned”, host array, copy the host data to the pinned array, and then transfer the data from the pinned array to device memory, as illustrated below.")])]),t._v(" "),n("p",[n("img",{attrs:{src:s(357),alt:""}})]),t._v(" "),n("p",[t._v("所以設定 "),n("code",[t._v("pin_memory=True")]),t._v(" 就只是先傳入鎖定分頁的記憶體上，之後要搬到 GPU 就可以直接搬。在 "),n("code",[t._v("DataLoader")]),t._v(" 中意義更重大，設定好就不會每次讀取資料都要鎖定。")]),t._v(" "),n("h2",{attrs:{id:"如何在-dataloader-中使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何在-dataloader-中使用"}},[t._v("#")]),t._v(" 如何在 DataLoader 中使用")]),t._v(" "),n("p",[t._v("通常是直接下參數 "),n("code",[t._v("pin_memory=True")]),t._v("，它會辨識 "),n("code",[t._v("Dataset")]),t._v(" 回傳的物件中，哪些是屬於 "),n("code",[t._v("Tensor")]),t._v(" 型別的資料，還有「"),n("code",[t._v("dict")]),t._v(" 或是 iterable 的容器物件中，包含 "),n("code",[t._v("Tensor")]),t._v(" 型別的資料」，把這些資料傳入 pinned memory。如果是自製的資料型別，就必須自己寫一個包含 "),n("code",[t._v("pin_memory(self)")]),t._v(" 函式的類別，傳入參數 "),n("code",[t._v("collate_fn")]),t._v("，來指定設定 "),n("code",[t._v("pin_memory=True")]),t._v(" 時該有的行為。以下是官網的範例：")]),t._v(" "),n("div",{staticClass:"language-python extra-class"},[n("pre",{pre:!0,attrs:{class:"language-python"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SimpleCustomBatch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("__init__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        transposed_data "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("zip")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transposed_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tgt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("transposed_data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# custom memory pinning method on custom type")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("pin_memory")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pin_memory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tgt "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tgt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pin_memory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" self\n\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("collate_wrapper")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("batch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" SimpleCustomBatch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("batch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\ninps "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("arange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dtype"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("float32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ntgts "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("arange"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dtype"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("torch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("float32"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("view"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ndataset "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" TensorDataset"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inps"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tgts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nloader "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" DataLoader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataset"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" batch_size"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" collate_fn"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("collate_wrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    pin_memory"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" batch_ndx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sample "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enumerate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("loader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sample"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_pinned"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sample"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tgt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_pinned"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("從範例中可以看到，"),n("code",[t._v("DataLoader")]),t._v(" 在取出一個 batch 的資料時，會去呼叫它的 "),n("code",[t._v("pin_memory()")]),t._v(" 函式。所以如果自製的 Batch 型別並非上述的容器物件，必須自己實作 "),n("code",[t._v("pin_memory()")]),t._v("。")]),t._v(" "),n("h2",{attrs:{id:"參考資料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#參考資料"}},[t._v("#")]),t._v(" 參考資料")]),t._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://pytorch.org/docs/stable/data.html#memory-pinning",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pytorch.org/docs/stable/data.html#memory-pinning"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://pytorch.org/docs/stable/notes/cuda.html#cuda-memory-pinning",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://pytorch.org/docs/stable/notes/cuda.html#cuda-memory-pinning"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://developer.nvidia.com/blog/how-optimize-data-transfers-cuda-cc/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://developer.nvidia.com/blog/how-optimize-data-transfers-cuda-cc/"),n("OutboundLink")],1)]),t._v(" "),n("li",[n("a",{attrs:{href:"https://discuss.pytorch.org/t/when-to-set-pin-memory-to-true/19723",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://discuss.pytorch.org/t/when-to-set-pin-memory-to-true/19723"),n("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);